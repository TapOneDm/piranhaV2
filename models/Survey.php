<?php

namespace app\models;

use Yii;
use yii\base\Model;

class Survey extends Model {
    const TAG_TECH = 'tech';
    const TAG_DIPLOMACY = 'diplomacy';
    const TAG_SPORTS = 'sports';
    const TAG_CREATIVE = 'creative';
    const TAG_BUSINESS = 'business';
    const TAG_ADVENTURE = 'adventure';
    const TAG_ANALYSIS = 'analysis';
    
    public $question1;
    public $question2;
    public $question3;
    public $question4;
    public $question5;
    public $question6;
    public $question7;
    public $question8;

    public function rules()
    {
        return [
            ['start', 'safe'],
            [
                [
                    'question1',
                    'question2',
                    'question3',
                    'question4',
                    'question5',
                    'question6',
                    'question7',
                    'question8',
                ],
                'integer',
            ],
            ['question1', 'required', 'on'=>'q1'],
            ['question2', 'required', 'on'=>'q2'],
            ['question3', 'required', 'on'=>'q3'],
            ['question4', 'required', 'on'=>'q4'],
            ['question5', 'required', 'on'=>'q5'],
            ['question6', 'required', 'on'=>'q6'],
            ['question7', 'required', 'on'=>'q7'],
            ['question8', 'required', 'on'=>'q8'],
        ];
    }

    public function attributeLabels() {
        return [
            'question1' => Yii::t('app', 'Как ваш ребёнок чаще всего ведёт себя на площадке?'),
            'question2' => Yii::t('app', 'Что ему интереснее всего дома?'),
            'question3' => Yii::t('app', 'Как он реагирует на новые ситуации?'),
            'question4' => Yii::t('app', 'Как вы думаете, где его сильная сторона?'),
            'question5' => Yii::t('app', 'Что больше всего утомляет вашего ребёнка?'),
            'question6' => Yii::t('app', 'Как он лучше всего учится?'),
            'question7' => Yii::t('app', 'Если бы ваш ребёнок оказался героем фильма, кем бы он был?'),
            'question8' => Yii::t('app', 'Что для вас важнее всего в активности для ребёнка?'),
        ];
    }

    public function scenarios() {
        return array_merge(parent::scenarios(),[
            'q1' => ['question1'],
            'q2' => ['question2'],
            'q3' => ['question3'],
            'q4' => ['question4'],
            'q5' => ['question5'],
            'q6' => ['question6'],
            'q7' => ['question7'],
            'q8' => ['question8'],
        ]);
    }

    public static function getAnswerList()
    {
        return [
            'question1' => [
                1 => 'Бегает и крутится, не сидит на месте.',
                2 => 'Занимает компанию и заводит друзей.',
                3 => 'Предпочитает наблюдать за другими.',
                4 => 'Увлечён в свой мир игр/фантазий.',
                5 => 'Сидит и собирает конструктор или что-то мастерит.',
            ],
            'question2' => [
                1 => 'Футбол или активные игры.',
                2 => 'Настольные игры, задачки.',
                3 => 'Рисование, творчество.',
                4 => 'Театральные постановки/игры с друзьями.',
                5 => 'Компьютер, книги, эксперименты.',
            ],
            'question3' => [
                1 => 'Сразу бежит навстречу приключениям.',
                2 => 'Сначала наблюдает, потом осторожно пробует.',
                3 => 'Начинает организовывать других.',
                4 => 'Вовлекает друзей и знакомых.',
                5 => 'Уходит в себя и придумывает свою версию происходящего.',
            ],
            'question4' => [
                1 => 'Физическая энергия.',
                2 => 'Общение и дружба.',
                3 => 'Умение мыслить стратегически.',
                4 => 'Творчество и фантазия.',
                5 => 'Внимание к деталям.',
            ],
            'question5' => [
                1 => 'Шум и толпа.',
                2 => 'Слишком много информации/гаджетов.',
                3 => 'Адреналин и эмоции.',
                4 => 'Скука и рутина.',
                5 => 'Давление и стресс от решений.',
            ],
            'question6' => [
                1 => 'Через движение и практику.',
                2 => 'Через командную работу.',
                3 => 'Через наблюдение и анализ.',
                4 => 'Через творчество и визуальные образы.',
                5 => 'Через решение задач и планирование.',
            ],
            'question7' => [
                1 => 'Спортсменом-чемпионом.',
                2 => 'Главным дипломатом или премьером.',
                3 => 'Храбрым исследователем.',
                4 => 'Гениальным учёным или предпринимателем.',
                5 => 'Художником или философом.',
                6 => 'Сыщиком, раскрывающим тайны.',
            ],
            'question8' => [
                1 => 'Чтобы тратил энергию и рос здоровым.',
                2 => 'Чтобы заводил друзей.',
                3 => 'Чтобы научился концентрироваться.',
                4 => 'Чтобы развивал творческие способности.',
                5 => 'Чтобы умел справляться со стрессом.',
            ],
        ];
    }

    public static function getResultDataMap()
    {
        return [
            static::TAG_TECH => [
                'title' => Yii::t('app', 'Будущий Илон Маск'),
                'text' => Yii::t('app', 'Изобретатель по натуре: конструкторы, шахматы, программирование — его вселенная. Скорее всего, у него будет сидячий образ жизни, а это риск для осанки и искривления позвоночника. В Piranha есть специальные методики для работы над осанкой: плавание укрепляет спину, формирует здоровый рост и помогает мозгу работать ещё лучше. Вода также защищает от сенсорного перегруза от гаджетов и информации.'),
            ],
            static::TAG_DIPLOMACY => [
                'title' => Yii::t('app', 'Будущий министр иностранных дел'),
                'text' => Yii::t('app', 'Дружелюбный дипломат: легко улаживает споры и находит общий язык с кем угодно. Театр, командные игры и публичные выступления — его стихия. Но чтобы костюм сидел идеально, нужна ровная спинка и правильная осанка. А ещё настоящему переговорщику нужно уметь справляться с сенсорной перегрузкой от шума, толпы и общения. Плавание в Piranha укрепляет тело, развивает выносливость и возвращает баланс.'),
            ],
            static::TAG_SPORTS => [
                'title' => Yii::t('app', 'Новый Квича Кварацхелия'),
                'text' => Yii::t('app', 'Энергичный как вулкан: активные виды спорта — его стихия. Но футбол и другие нагрузки часто связаны с травмами. Чтобы они не помешали развитию спортивной карьеры, важно укреплять организм и делать профилактику. Врачи советуют плавание как лучший способ восстановления. Вода также помогает снять сенсорное перенапряжение от адреналина и эмоций.'),
            ],
            static::TAG_CREATIVE => [
                'title' => Yii::t('app', 'Пиросмани XXI века'),
                'text' => Yii::t('app', 'Творческая натура: рисует, фантазирует, сочиняет истории. Даже если он не станет писать шедевры на стенах тбилисских домов, осанка и дыхание должны быть правильными. Плавание в Piranha развивает лёгкие, укрепляет спину и улучшает межполушарное взаимодействие: движения в воде помогают творческим детям соединять фантазию с логикой. А вода разгружает зрительное восприятие, снимая перегруз от красок, деталей и ярких образов.'),
            ],
            static::TAG_BUSINESS => [
                'title' => Yii::t('app', 'Топ из списка Forbes'),
                'text' => Yii::t('app', 'Маленький стратег и предприниматель от Бога: всё просчитывает, планирует и ищет выгодные ходы. Настолки, головоломки и «мини-бизнесы» — его стихия. Но настоящий талант должен уметь справляться со стрессом. В Piranha плавание помогает сбросить напряжение, укрепить тело и развить выносливость. А вода снимает сенсорный перегруз от постоянных решений и давления, позволяя будущему гению сделок мыслить яснее.'),
            ],
            static::TAG_ADVENTURE => [
                'title' => Yii::t('app', 'Новый Индиана Джонс или артист Сухишвили'),
                'text' => Yii::t('app', 'Весёлый искатель приключений: ему подавай новые авантюры и впечатления. Даже если ему не суждено колесить в туре с национальным балетом Грузии, осанка должна быть идеальной. Плавание даёт те же ощущения открытия, но безопаснее и полезнее: укрепляет тело и формирует ровную спину. А ещё вода помогает справляться с сенсорной перегрузкой от бесконечного потока эмоций и впечатлений.'),
            ],
            static::TAG_ANALYSIS => [
                'title' => Yii::t('app', 'Шерлок NextGen'),
                'text' => Yii::t('app', 'Внимательный наблюдатель: замечает то, что другим ускользает, и любит разгадывать загадки. Его сила — в тишине и деталях. Но когда вокруг слишком много шума, событий и информации, наступает сенсорная перегрузка, и даже его R.A.S. (система фильтрации внимания) начинает давать сбои. Плавание в Piranha помогает перезагрузить восприятие, укрепить тело и сохранить остроту ума сыщика нового поколения.'),
            ],
        ];
    }

    public function calculateSumTags()
    {
        $qestionsResultMap = \app\components\Helper::getSurveyQuestionResultMap();
        $modelResult = $this->toArray();
        
        $data = [];
        foreach ($modelResult as $key => $value) {
            $data[$key] = $qestionsResultMap[$key][$value];
        }

        $sums = [];
        foreach ($data as $question) {
            foreach ($question as $tag => $value) {
                if (!isset($sums[$tag])) {
                    $sums[$tag] = 0;
                }
                $sums[$tag] += $value;
            }
        }

        if (empty($sums)) {
            return '';
        }

        $priorityOrder = [
            static::TAG_TECH,
            static::TAG_DIPLOMACY,
            static::TAG_SPORTS,
            static::TAG_CREATIVE,
            static::TAG_BUSINESS,
            static::TAG_ADVENTURE,
            static::TAG_ANALYSIS,
        ];

        $maxSum = max($sums);

        // Filter tags that share the max sum
        $maxTags = array_filter($sums, fn($sum) => $sum === $maxSum);

         // Sort max tags based on priority order
        usort($priorityOrder, function ($a, $b) use ($maxTags, $priorityOrder) {
            $posA = array_search($a, $priorityOrder);
            $posB = array_search($b, $priorityOrder);
            return $posA <=> $posB;
        });

        foreach ($priorityOrder as $tag) {
            if (isset($maxTags[$tag])) {
                return $tag;
            }
        }

        return key($maxTags);
    }

    public function getResultData()
    {
        $tag = $this->calculateSumTags();

        return static::getResultDataMap()[$tag];
    }
}
